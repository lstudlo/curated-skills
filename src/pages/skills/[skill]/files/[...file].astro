---
import Layout from '../../../../layouts/Layout.astro';
import {
  buildSkillDownloadHref,
  getSkillBySlug,
  getSkillFileContent,
  getSkillFileStaticPaths,
} from '../../../../lib/skills';

export const prerender = true;

export async function getStaticPaths() {
  return getSkillFileStaticPaths();
}

const skillSlug = Astro.params.skill ?? '';
const relativePath = Astro.params.file ?? '';
const fileContent = await getSkillFileContent(skillSlug, relativePath);
const skill = fileContent?.skill ?? (await getSkillBySlug(skillSlug));

if (!skill) {
  throw new Error(`Unknown skill for file route: ${skillSlug}`);
}

const fileMeta = fileContent?.file ?? skill.files.find((entry) => entry.relativePath === relativePath);

if (!fileMeta) {
  throw new Error(`Unknown file "${relativePath}" in skill "${skillSlug}"`);
}

const lines = fileContent ? fileContent.content.replace(/\r\n/g, '\n').split('\n') : [];
const isLongFile = lines.length > 600;
---

<Layout
  title={`${fileMeta.name} · ${skill.title} · Curated Skills`}
  description={`View ${fileMeta.relativePath} from the ${skill.title} skill.`}
>
  <div class="space-y-5">
    <nav class="min-w-0 text-xs text-zinc-500">
      <a href="/" class="hover:text-zinc-900 hover:underline dark:hover:text-zinc-100">Skills</a>
      <span class="mx-2">/</span>
      <a href={`/skills/${encodeURIComponent(skill.slug)}/`} class="hover:text-zinc-900 hover:underline dark:hover:text-zinc-100">
        {skill.directoryName}
      </a>
      <span class="mx-2">/</span>
      <span class="font-mono">{fileMeta.relativePath}</span>
    </nav>

    <section class="rounded-3xl border border-zinc-200/80 bg-white/75 p-5 backdrop-blur sm:p-6 dark:border-zinc-800 dark:bg-zinc-950/70">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
        <div class="min-w-0">
          <p class="text-[11px] tracking-[0.16em] text-zinc-500 uppercase">{skill.title}</p>
          <h1 class="mt-2 break-all font-mono text-lg leading-7 text-zinc-900 dark:text-zinc-100 sm:text-xl">
            {fileMeta.relativePath}
          </h1>
          <div class="mt-3 flex flex-wrap gap-2">
            <span class="rounded-full border border-zinc-300/80 px-3 py-1 text-xs font-mono dark:border-zinc-700">
              {fileMeta.extension || 'file'}
            </span>
            <span class="rounded-full border border-zinc-300/80 px-3 py-1 text-xs font-mono dark:border-zinc-700">
              {lines.length} lines
            </span>
            {!fileContent && (
              <span class="rounded-full border border-zinc-300/80 px-3 py-1 text-xs font-mono dark:border-zinc-700">
                Binary / non-text preview unavailable
              </span>
            )}
          </div>
        </div>

        <div class="flex shrink-0 flex-wrap gap-2">
          <a
            href={`/skills/${encodeURIComponent(skill.slug)}/`}
            class="rounded-full border border-zinc-300/80 px-4 py-2 text-xs tracking-[0.16em] uppercase hover:bg-zinc-100 dark:border-zinc-700 dark:hover:bg-zinc-900"
          >
            Back to Skill
          </a>
          <a
            href={buildSkillDownloadHref(skill.slug, fileMeta.relativePath)}
            download
            class="rounded-full border border-[var(--accent)] bg-[var(--accent)] px-4 py-2 text-xs tracking-[0.16em] text-white uppercase hover:opacity-90 dark:text-zinc-950"
          >
            Download File
          </a>
        </div>
      </div>
    </section>

    {fileContent ? (
      <section class="overflow-hidden rounded-2xl border border-zinc-200/80 bg-white/75 backdrop-blur dark:border-zinc-800 dark:bg-zinc-950/70">
        <div class="border-b border-zinc-200/80 px-4 py-3 text-[11px] tracking-[0.16em] text-zinc-500 uppercase dark:border-zinc-800">
          {isLongFile ? 'Preview (large file)' : 'Content'}
        </div>
        <pre class="overflow-x-auto p-4 font-mono text-xs leading-6 text-zinc-800 dark:text-zinc-200 sm:p-5"><code>{fileContent.content}</code></pre>
      </section>
    ) : (
      <section class="rounded-2xl border border-zinc-200/80 bg-white/75 p-5 text-sm text-zinc-600 backdrop-blur dark:border-zinc-800 dark:bg-zinc-950/70 dark:text-zinc-300">
        This file is not rendered inline. Use <strong>Download File</strong> to retrieve it.
      </section>
    )}
  </div>
</Layout>
